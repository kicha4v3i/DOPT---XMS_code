{% extends "base.html" %}
    {% block content %}
    {% load static %}
    {% load app_filters %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/pages/app-user.css' %}">
    
    <section class="page-users-view">
      <div class="container-fluid">
      <div class="row align-items-start common-row-space">
      <div class="col-md-12 p-0 create-pg">
        <div class="create_project_sec scroll-line new-cru-well">          
          {% include "header.html" %}
          <div class="col-sm-12 text-right">
            <a class="btn btn-primary detail-button top-mrr" href="{{request.META.HTTP_REFERER}}">Go Back</a>
            </div>

        {% if perms.custom_auth.change_companies %}
        {% if data.status == 0 %}
        {% if payment_details.count != 0 %}
        <div class="row">
            <div class="col-12">
                <!-- Outline buttons -->
                <a  href="{% url 'custom_auth:companyreject' data.id %}" class="btn btn-outline-danger mr-1 mb-1 waves-effect waves-light float-right paay-ment">Reject</a>
                <a  href="{% url 'custom_auth:companyapprove' data.id %}" class="btn btn-outline-success mr-1 mb-1 waves-effect waves-light float-right paay-ment">Approve</a>
            </div>
        </div>
        {% else %}
        <a class="btn btn-outline-success mr-1 mb-1 waves-effect waves-light float-right paay-ment" id="company_approve" data_id="{{data.id}}">Paymentss</a>
        {% endif %}
        {% else %}
        {% if payment_details.count != 0 %}
        <!-- {% if company_payment.payment_status == 0 %}
        <div class="row">
            <div class="col-12">
                <a  href="{% url 'custom_auth:companyreject' data.id %}" class="btn btn-outline-danger mr-1 mb-1 waves-effect waves-light float-right paay-ment">Reject</a>
                <a  href="{% url 'custom_auth:companyapprove' data.id %}" class="btn btn-outline-success mr-1 mb-1 waves-effect waves-light float-right paay-ment">Approve</a>
            </div>
        </div>
        {% endif %} -->
        {% else %}
        <!-- <a class="btn btn-outline-success mr-1 mb-1 waves-effect waves-light float-right paay-ment" id="company_approve" data_id="{{data.id}}">Payment</a> -->
        {% endif %}
        {% endif %}

        
        {% endif %}
<!-- <section id="data-list-view" class="data-list-view-header"> -->
    <div class="row" id="basic-table">
  
        <div class="col-12 p-0">
 
          <div class="card pt-2 pb-2">
            {% if license_type == 'CompanyPlan' %}
            <div>
              <h4 class="card-title common-txt-center">Company Details</h4>
            </div>
            {% elif license_type == 'Enterprise' %}
            <div>
              <h4 class="card-title common-txt-center">Enterprise Details</h4>
            </div>
            {%else%}
            <div class"">
              <h4 class="card-title text-center">Individual Details</h4>
            </div>
            {%endif%}

            <div class="table-responsive">
              <table class="table com-de-tbl table-wid">
                <tbody>
                  {% if license_type == 'CompanyPlan' %}
                  <tr>
                    <th>
                      <span class="font-weight-bold">Company Name</span>
                    </th>
                    <td>
                     {{data.company_name}}
                    </td>
                  </tr>
                  {%endif%}
                  <tr>
                    <th>
                      <span class="font-weight-bold">Name</span>
                    </th>
                    <td>
                      {% if license_type == 'Individual' %}
                        {{data.name}}  
                        {% if license_type == 'Individual' %}
                          {{data.lastname}}
                        {%else%}
                          {{data.last_name}}
                        {%endif%}
                      {%else%}
                        {{data.first_name}}
                        {% if license_type == 'Individual' %}
                        {{data.lastname}}
                        {%else%}
                          {{data.last_name}}
                        {%endif%}
                      {%endif%}
                    </td>
                  </tr>
                  
                  {% if license_type != 'Individual' %}
                  <tr>
                    <th>
                      <span class="font-weight-bold">Designation</span>
                    </th>
                    <td>
              
                     {{getmainuser_details.designation}}
                    </td>
                  </tr>
                  {%endif%}
                <tr>
                    <th class="font-weight-bold">Email</th>
                    <td>{{data.email}}</td>
                </tr>
               
              
                  

                  
                </tbody>
              </table>
            </div>

            <div class="card-heade">
                <h4 class="card-title project-title tlt-ce-nter mt-2">License Packages</h4>
              </div>
              <div class="table-responsive">
                <table class="table com-de-tbl table-wid">
                  <tbody>
                    {% if license_type != 'Individual' %}
                      {% for licence in licences %}
                        <tr>
                          <th>
                            <span class="font-weight-bold">No of users</span>
                          </th>
                          <td>{{licence.concurrent_users}}</td>
                        </tr>
                      {% endfor %}
                    {%endif%}
                  
                    {% poauser_rights_permission 'Date of Subscription' request as value %}
                    {% if value %}
                    <tr>
                      <th>
                        <span class="font-weight-bold">Date of Subscription</span>

                      </th>
                      <td>{% changedateformat data.start_date  %} </td>
                    </tr>
                    {%endif%}
                    {% poauser_rights_permission 'Expiry Information' request as value %}
                    {% if value %}
                    <tr>
                      <th>
                        <span class="font-weight-bold">Expiry Information</span>

                      </th>
                      <td>{% changedateformat data.end_date  %}</td>

                    </tr>
                    {%endif%}
                    {% poauser_rights_permission 'Type of Subscription' request as value %}
                    {% if value %}
                    <tr>
                      <th>
                        <span class="font-weight-bold">License Type</span>

                      </th>
                      <td> {% if license_type == 'CompanyPlan' %} 
                        Company 
                      {%else%}
                        {{license_type}} 
                      {%endif%}
                      / {{subscription_type}}
                    </td>

                    </tr>
                    {%endif%}
                  </tbody>
                </table>
              </div>
              {% getEnquiries data license_type as enquiries %}
              {% if enquiries|length > 0 %}
              <div class="card-heade">
                <h4 class="card-title project-title tlt-ce-nter">License Enquiries</h4>
              </div>
               <div class="table-responsive">
                <table class="table com-de-tbl table-bordered">
                  <thead>
                    <th>No of users</th>
                  </thead>
                  <tbody>
                  
                     
                  {% for enquiry in enquiries %}
                  <form method="POST" id="enquiry_form">
                    {% csrf_token %}
                    <tr>
                      <td>{{enquiry.no_of_users}}</td>
                      <input type="hidden" value="{{enquiry.id}}" name="enquiry_result">
                      <td>
                        <button class="se-nd" type="submit" name="status" value="accept">
                          Accept
                        </button>
                        
                      </td>
                      <td>
                        <button class="chip chip-warning" type="submit" name="status"  value="decline">Decline</button>
                      </td>
                      
                    </tr>
                  </form>
                {% endfor %}
              
              {% for enquiry in enquiries %}
                <form method="POST" id="enquiry_form">
                  {% csrf_token %}
                  <div class="row">
                    <div class="col-3">
                      {{enquiry.no_of_users}}
                      <input type="hidden" value="{{enquiry.id}}" name="enquiry_result">
                    </div>
                    <div class="col-3">
                      <button class="btn btn-primary waves-effect  waves-float waves-light detail-button " type="submit" name="status" value="accept">
                        Accept
                      </button>
                    </div>
                    <div class="col-3">
                      <button class="btn btn-primary waves-effect  waves-float waves-light detail-button " type="submit" name="status"  value="decline">Decline</button>
                    </div>
                  </div>
                </form>
              {% endfor %}
              {%endif%}
<!-- 
              <div class="card-heade">
                <h4 class="card-title project-title tlt-ce-nter">Payment Details</h4>
              </div>
              <div class="table-responsive">
                <table class="table com-de-tbl">
                  <tbody>
                    {% for payment in payment_details %}
                    <tr>
                    <tr>
                      <th>
                        <span class="font-weight-bold">Amount</span>
                      </th>
                      <td>{{payment.amount}}</td>
                    </tr>
                   
                    
                    {% endfor %}
                  </tbody>
                </table>
              </div> -->

              <!-- <div class="col-sm-9 offset-sm-3">
                <a class="btn btn-primary pull-right detail-button" href="{{request.META.HTTP_REFERER}}">Go Back</a>
                </div>



          </div>
        </div>
      </div>
      <div class="modal" tabindex="-1" role="dialog" id="invoice-popup">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title popp-hdg">Payment</h5>
              <button type="button" id="invoice_close" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true" class="clo-ss">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form method="post" id="payment_invoice_form" name="payment_invoice_form" >
                {% csrf_token %}   
                <div class="row">
                    <input type="hidden" name="company_id" id="company_id">
                    <div class="col-12">
                        <label class="pop-com-hed">Date</label>
                        <input type="text" id="invoice_date" class="form-control invoice_date" name="invoice_date" placeholder="Date">
                        <span id="invoice_date_error" style="color: red;"></span>
                    </div>
                    <div class="col-12">
                        <label class="pop-com-hed">Invoice No</label>
                        <input id="invoice_no" type="text" class="form-control invoice_no" name="invoice_no" placeholder="Invoice No" >
                        <span id="invoice_no_error" style="color: red;"></span>
                    </div>
                    <div class="col-12">
                        <label class="pop-com-hed">Currency</label>
                        <select class="form-control currency mar-botm" id="currency" name="currency" >
                            <option value="">--Select--</option>
                            {% for currency in currencies %}
                            <option value="{{currency.currency}}">{{currency.currency}}</option>
                            {% endfor %}
    
                        </select>
                        <span id="currency_error" style="color: red;"></span>
                    </div>
                    <div class="col-12">
                        <label class="pop-com-hed">Amount</label>

                        <input id="amount" type="number" class="form-control amount" name="amount" placeholder="Amount">
                        <span id="amount_error" style="color: red;"></span>
                    </div>
                    
                </div> 
                <div class="button-cen-lic">
                  <button type="button" id="invoice_submit_btn" class="btn waves-effect pop-comsub waves-float waves-light detail-button">Submit</button>
                </div>   
                <!-- <input type="button" id="invoice_submit_btn" value="Submit" class="btn waves-effect pop-comsub waves-float waves-light detail-button"> -->
                </form>  
            </div>
           
          </div>
        </div>
      </div>
      {% include "footer.html" %}
      </div>
      <!-- <div class="col-md-2">
        {% include "userheader.html" %}
      </div> -->
      </div>
    </div>
      
    </section>
    <script>
      $(document).ready( function () {
          $('.table_css').DataTable();    
          $('#company_approve').click(function(){
              var company_id=$(this).attr('data_id')
              $('#company_id').val(company_id)
              $('#invoice-popup').show()
          })        
          $(document).on("click", "#invoice_submit_btn" , function() { 
            var invoice_no=$("#invoice_no").val();
            var amount=$("#amount").val();
            var company_id=$('#company_id').val();
            var currency=$('#currency').val();
            var date=$('#invoice_date').val();
            if(date==''){
                $('#invoice_date_error').html('Please provide a date')
            }else{
                $('#invoice_date_error').html('')
            }
            if(invoice_no==''){
                $('#invoice_no_error').html('Please Enter a number')
            }else{
                $('#invoice_no_error').html('')
            }
            if(currency==''){
                $('#currency_error').html('Please select a currency')
            }else{
                $('#currency_error').html('')
            }
            if(amount==''){
                $('#amount_error').html('Please Enter a amount')
            }else if(amount == 0 ){
                $('#amount_error').html('Please Enter a minimum amount')
            }else{
                $('#amount_error').html('')
            }
            
            if (invoice_no !='' && currency!='' && date!='' && amount!='' && amount !=0 ){
                payment_invoice_validation(invoice_no,amount,company_id,date)
            }
            function payment_invoice_validation(data){
                $.ajax({ 
                type: "POST",                      
                url: "{% url 'custom_auth:addinvoice' %}",                  
                data: {
                    invoice_no:invoice_no,
                    amount:amount,
                    company_id:company_id,
                    currency:currency,
                    date:date,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                },
                dataType: "json",
                success: function (data) { 
                    if(data.status=='success') {
                        $('#invoice-popup').hide()
                        window.location.reload(true);
                    }
              
                }
            });
        }
        
    });
    $("#invoice_date").on('change',function(){
      if($(this).val()){
        $('#invoice_date_error').html('')
      }
    })
    $("#invoice_no").on('keyup',function(){
      if($(this).val() !=""){
        $('#invoice_no_error').html('')
      }else{
        $('#invoice_no_error').html('Please Enter a number')
      }
    });
    $("#currency").on("change",function(){
      if($(this).val()){
        $('#currency_error').html('')
      }
    })
    $("#amount").on("keyup",function(){
      if($(this).val()){
        $("#amount_error").html('')
      }
    })
      $('#invoice_close').click(function(){
          $('#invoice-popup').hide()
      })

      $('#company_upgrade').click(function(){
        var company_id=$(this).attr('data_id');
        alert(company_id);
      })

      } );
      
      $('body').on('focus',".invoice_date", function(){
          $(this).flatpickr({
              // minDate: "today",
              dateFormat: "d-m-Y",
              defaultDate: $(this).val()!=''?$(this).val():new Date()
          });
      });

      </script>
    {% endblock %}







    
    
        